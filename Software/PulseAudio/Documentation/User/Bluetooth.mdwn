[[!inline pages="Software/PulseAudio/TOC" quick="yes" raw="yes"]]

# Bluetooth

PulseAudio depends on [[BlueZ|http://www.bluez.org]] for all Bluetooth functionality, and additionally [[oFono|https://01.org/ofono]] is required for HFP support.

## Profiles

The bluetooth standard specifies three audio profiles. Don't confuse these with the "card profile" concept in PulseAudio. A bluetooth device shows up in PulseAudio as a card, and the card will have some set of profiles depending on what bluetooth profiles the device supports, but the "bluetooth profile" <-> "card profile" mapping is not one-to-one. The three bluetooth profiles are:

* A2DP (Advanced Audio Distribution Profile) - high-quality audio playback, appropriate for e.g. listening to music.
* HSP (HeadSet Profile) - phone-quality audio playback and recording, appropriate for phone calls.
* HFP (Hands-Free Profile) - same as HSP, but with additional functionality for managing phone calls.

Each of the profiles are further divided into two roles:

* A2DP:
  * Source role - the device that sends audio.
  * Sink role - the device that receives audio.
* HSP:
  * Audio Gateway role - the device that the headset is connected to. The HSP profile is typically used in phone calls, and this is the device that is connected to the cellular network (for cellular phone calls) or to the internet (for VoIP calls). Typically a cellular phone or a personal computer.
  * Headset role - the headset, obviously. This is where the speakers and microphone are.
* HFP:
  * Audio Gateway role - the device that the hands-free device is connected to. The HFP profile is typically used for cellular phone calls, and this is the device that is connected to the cellular network. Typically a cellular phone.
  * Hands-Free Unit role - the device with the speakers and microphone.

## A2DP

PulseAudio supports A2DP in both source and sink roles. When PulseAudio acts in the source role, a sink is created where applications can play to. When PulseAudio acts in the sink role, a source is created where applications can record from.

A2DP works generally without a hassle, although when watching videos, the audio can get badly out of sync. It seems that in case of transmission problems (weak signal, or out of signal range) the kernel can buffer quite a lot of audio. Here's a bug report about this issue: [[https://bugs.freedesktop.org/show_bug.cgi?id=58746]]. A patch is available on that page, but it breaks HSP, so it can't be accepted. The general idea of the patch seems fine, though. Help with improving the patch would be very welcome.

## HSP

PulseAudio supports HSP only in the audio gateway role, so headsets can be used with PulseAudio, but PulseAudio can't act as a headset. (With BlueZ 4 both roles are supported, but almost everyone uses BlueZ 5 nowadays.) With the "Headset Head Unit (HSP/HFP)" card profile selected, PulseAudio will create a sink and a source that applications can use to play back and record audio.

The HSP implementation in PulseAudio is mutually exclusive with the HFP implementation, so users have to choose which one is more important to them. There's no reason why the two profiles absolutely have to be mutually exclusive, but that's the way it is for now.

HSP support is enabled by passing argument "headset=native" to module-bluetooth-discover in /etc/pulse/default.pa. Or the argument can be omitted, because HSP is enabled by default.

The headset role will eventually be supported too. In fact, there's already a patch for that: [[https://lists.freedesktop.org/archives/pulseaudio-discuss/2015-February/023242.html]]. Arun reviewed the patch, and there was something to fix in the patch, but the feedback was given in IRC, so the details are not archived. No new version of the patch has been submitted. Contact Arun Raghavan and Wim Taymans if you want more information about this, or if you want to help finishing the work.

## HFP

PulseAudio supports HFP only in the hands-free unit role (opposite to the situation with HSP), so PulseAudio can connect to a mobile phone, but not to headsets and other hands-free devices. With the "Headset Audio Gateway (HSP/HFP)" card profile selected, PulseAudio will create a sink and a source that applications can use to play back and record audio - or more commonly, the bluetooth sink and source will be connected with module-loopback to speakers and a microphone device. Note that the "Headset Audio Gateway (HSP/HFP)" card profile is typically automatically activated by module-bluetooth-policy when the phone initiates audio streaming.

As mentioned in the HSP section, support for HFP and HSP are currently mutually exclusive. HFP support is enabled by passing argument "headset=ofono" to module-bluetooth-discover in /etc/pulse/default.pa.

The audio gateway role will hopefully be supported too in the future, as well as simultaneous support for HSP and HFP. Simon Fels has done some work on both of these things: [[https://github.com/morphis/pulseaudio/commits/master-bt-fixes]]. Those patches have not yet been submitted to upstream, however.

James Bottomley submitted different patches for supporting HFP headsets, which don't use oFono: [[https://www.mail-archive.com/pulseaudio-discuss@lists.freedesktop.org/msg16443.html]]. The patches need some work, but nothing has happened for a long time. Someone else could relatively easily finish off the work - just read the review discussion, and address the points raised.

## Using bluetooth when running PulseAudio in the system mode

For some reason the bluetooth modules aren't included in /etc/pulse/system.pa by default, so if you want to use bluetooth, add this to /etc/pulse/system.pa:

    load-module module-bluetooth-discover
    load-module module-bluetooth-policy

It's generally recommended to disallow module loading when using PulseAudio in the system mode, because if the system administrator doesn't trust the users, allowing users to load modules may not be a good idea. However, bluetooth doesn't work if module loading is disallowed (this is a bug that somebody should fix), so if it's more important to have bluetooth support than to prevent users from loading (and unloading) modules, make sure you don't disallow module loading (by default module loading is allowed).

The D-Bus access policy doesn't allow pulseaudio to communicate with bluetoothd by default when running pulseaudio in the system mode. Add the user "pulse" to group "bluetooth" to grant the permission.

The D-Bus access policy also doesn't allow pulseaudio to communicate with ofonod by default when running pulseaudio in the system mode. To grant the permission, add this to /etc/dbus-1/system.d/ofono.conf:

      <policy user="pulse">
        <allow send_destination="org.ofono"/>
      </policy>

## Using HFP with oFono

In typical desktop environments, connecting to a mobile phone with HFP isn't totally plug-and-play. The device has to be manually enabled in oFono first. To do that, get the oFono source code, which includes some test scripts that can be used to interact with oFono. First, run

    test/list-modems

That will list all modems (the phone will appear as a "modem" in oFono), look for the one with Type=hfp. Then, assuming that the phone is on path /hfp_path, run

    test/enable-modem /hfp_path

To disable the device, use this command:

    test/disable-modem /hfp_path

While the device is enabled, you can test that audio works by calling someone using the phone. You can also try to command the phone to make the call from your computer with this command:

    test/dial-number /hfp_path 12345

To hangup all ongoing calls, this command can be used:

    test/hangup-all /hfp_path

## Troubleshooting

### HSP problem: HSP stopped working when upgrading PulseAudio from 10.0 to 11.0

From the [[11.0 release notes|https://www.freedesktop.org/wiki/Software/PulseAudio/Notes/11.0/]]:

The packet size (a.k.a. MTU, "maximum transmission unit") that PulseAudio uses with the bluetooth HSP profile was previously always configured to be 48 bytes. That worked with most hardware, but some adapters require a different packet size. Now PulseAudio asks the kernel what packet size should be used, which fixes the problem.

However, a new problem appeared: some adapters that used to work with 48 byte packet size don't any more work with the size that the kernel tells PulseAudio to use. If you find that HSP audio stopped working when upgrading to PulseAudio 11.0, you can revert to the old behaviour by passing option "autodetect_mtu=no" to module-bluetooth-discover in /etc/pulse/default.pa. If that fixes the problem, then please report the problem to the BlueZ and/or PulseAudio developers, so that the kernel can be fixed.

### HSP problem: "Protocol not supported"

There was some regression in the kernel that was introduced in 3.12 and fixed in 3.18 that caused failure when trying to activate HSP with some headsets. This problem can be identified by this error message in pulseaudio log:

    backend-native.c: connect(): Protocol not supported
